---
output: 
  html_document: 
    keep_md: yes
---

# Cell area analysis in multiple ROI's

What if you suspect that different parts of the tissue are doing different cellular behaviours (or have different areas, for example) and you want to analyse them separately and compare them? In our example data we have provided three ROIs:

* raw (default ROI created by the workflow)
* whole_tissue (default ROI created by the workflow)
* cell_patch (user defined ROI, created by the author of this tutorial)

but in your own data, you can draw as many ROIs as necessary. ROIs can be overlapping (one cell can belong to many different ROIs). In our workflow, the information about which cells belong to which ROIs is not included in the database but accounted for separately by running the `tm sm roi_tracking` command. The following command will calculate cell area for the ROI called 'cell_patch' and then output a movie for that ROI in the output_analysis folder within the same movie directory.

### 1. Make a movie of cell area pattern plotted on the tissue for the *cell_patch* ROI

* Copy-paste the following commands in the terminal (watch the quotes !):

```
tm "sm roi_tracking; cell_area_pattern.R . output_analysis 'cell_patch'"
```

```{r cell_area_pattern, warning=FALSE, message=FALSE, fig.width=11, cache=FALSE, eval=TRUE, echo=FALSE, results='hide'}
movieDir="/Users/retourna/MovieDB/demo"

scriptsDir=Sys.getenv("TM_HOME")
if(is.na(file.info(scriptsDir)$isdir)){
  stop(paste("TM_HOME not correctly defined (",scriptsDir ,")"))
}

source(file.path(scriptsDir, "commons/TMCommons.R"))
source(file.path(scriptsDir, "commons/BaseQueryFunctions.R"))
source(file.path(scriptsDir, "config/default_config.R"))

cellArea <- mqf_fg_cell_area(movieDir, rois = c("cell_patch"), cellContour = T)

db <- openMovieDb(movieDir)

cellArea %>%
  render_frame(3) + 
  # we now map cell area values to a color palette: fill=area
  geom_polygon(aes(x_pos, y_pos, group=cell_id, fill=area), alpha=0.7) + 
  scale_fill_gradientn(name="area (px)",
                       colours=c("black", "blue", "green", "yellow", "red"),
                       limits=c(0,quantile(cellArea$area, probs = 99.9/100)),
                       na.value = "red") +
  ggtitle("cell_area_pattern")


```

[Where to find the results ?](../tm_qs_example_data.md#4-look-at-the-results) **|** 
[Back to tutorial list](../tm_qs_example_data.md#3-select-the-analysis-you-are-interested-in)

### 2. Plot cell area distrubution and averages in each ROI


* Copy-paste the following commands in the terminal:

```
tm "sm make_db; cell_area_graphs.R . output_analysis 'raw whole_tissue cell_patch'"
```

```{r cell_area_graphs, warning=FALSE, message=FALSE, fig.width=11, cache=FALSE, eval=TRUE, echo=FALSE,results='hide'}


movieDir="/Users/retourna/MovieDB/demo"

scriptsDir=Sys.getenv("TM_HOME")
if(is.na(file.info(scriptsDir)$isdir)){
  stop(paste("TM_HOME not correctly defined (",scriptsDir ,")"))
}


source(file.path(scriptsDir, "commons/TMCommons.R"))
source(file.path(scriptsDir, "commons/BaseQueryFunctions.R"))

mqf_cg_roi_cell_area(movieDir, rois = c("raw", "whole_tissue", "cell_patch")) %>% 
  ggplot(aes(dev_time, area.avg, color=movie)) +
  geom_line() +
  xlab("Time [h]") +
  ylab("<Cell area> [px]")  +
  facet_wrap(~roi) +
  ggtitle("averaged_cell_area")

mqf_fg_cell_area(movieDir, rois = c("raw", "whole_tissue", "cell_patch")) %>%
  ggplot(aes(area, fill=movie)) +
  geom_histogram(color="white") +
  xlab("Cell area [px]")  +
  facet_wrap(~roi) +
  ggtitle("cell_area_distribution")

mqf_fg_cell_area(movieDir, rois = c("raw", "whole_tissue", "cell_patch")) %>%
  ggplot(aes(movie,area, fill=movie)) +
  geom_boxplot() +
  ylab("Cell area [px]")  +
  facet_wrap(~roi) +
  ggtitle("cell_area_boxplot")

mqf_fg_cell_area(movieDir, rois = c("raw", "whole_tissue", "cell_patch")) %>%
  ggplot(aes(movie,area, fill=movie)) +
  geom_violin() +
  ylab("Cell area [px]")  +
  facet_wrap(~roi) +
  ggtitle("cell_area_violin")
```

[Where to find the results ?](../tm_qs_example_data.md#4-look-at-the-results) **|** 
[Back to tutorial list](../tm_qs_example_data.md#3-select-the-analysis-you-are-interested-in)

### 3. For further details

* compare multiple movies and ROI's, see [TM R User Manual](https://mpicbg-scicomp.github.io/tissue_miner/user_manual/TM_R-UserManual.html#comparing-averaged-quantities-between-movies-and-rois)
