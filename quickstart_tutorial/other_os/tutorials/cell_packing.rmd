---
output: 
  html_document: 
    keep_md: yes
---

# Cell packing analysis

### 1. Make a video of color-coded cell neighbor number plotted on the tissue

We want to colour code the movie by cell neighbor number.  The `tm sm make_db` command will first build a database from the segmented data (or return "Nothing to be done" if the database is already present). The next command on the right will run the cell neighbor number analysis and make the video we want. It takes the current movie directory `.` as an input and it outputs the results in the `output_analysis` folder within the same movie directory.


* Copy-paste the following commands in the terminal:

```
tm sm make_db; tm cell_neighbor_number_pattern.R . output_analysis
```

```{r cell_neighbor_number_pattern, warning=FALSE, message=FALSE, fig.width=11, cache=FALSE, eval=TRUE, echo=FALSE, results='hide'}
movieDir="/Users/retourna/MovieDB/demo"

scriptsDir=Sys.getenv("TM_HOME")
if(is.na(file.info(scriptsDir)$isdir)){
  stop(paste("TM_HOME not correctly defined (",scriptsDir ,")"))
}

source(file.path(scriptsDir, "commons/TMCommons.R"))
source(file.path(scriptsDir, "commons/BaseQueryFunctions.R"))
source(file.path(scriptsDir, "config/default_config.R"))

db <- openMovieDb(movieDir)

cellPolygonClass <- mqf_fg_cell_neighbor_count(movieDir, "raw", cellContour = T)

# Define a discrete color palette of polygon class
polygonClassColors <- c("2"="white","3"="black", "4"="green",
                        "5"="yellow", "6"="grey", "7"="blue",
                        "8"="red", "9"="purple", ">9"="black")

cellPolygonClass %>%
  render_frame(68) +
  geom_polygon(aes(x_pos, y_pos, fill=as.character(polygon_class_trimmed),
                   group=cell_id),  alpha=0.7) +
  scale_fill_manual(name="polygon class", values=polygonClassColors, drop=F) +
  ggtitle("PolygonClassPattern")


```

[Where to find the results ?](../tm_qs_example_data.md#4-look-at-the-results) **|** 
[Back to tutorial list](../tm_qs_example_data.md#3-select-the-analysis-you-are-interested-in)

### 2. Plot cell neighbor count and averages

We now want to make some graphs that demonstrate how the distributions of cell neighbor number behave in the movie. For example, we will make a graph to show how the averaged neighbor number changes over time.  We need a database, but we also need to run the `tm sm topo_countt1` command, which will take information from the database and detect cell neighbor changes (using a routine that is included in the automated workflow). This command will also build the database if not yet present. The next command on the right runs the analysis and makes the video we want. It takes the current movie directory `.` as an input and it outputs the results in the `output_analysis` folder within the same movie directory.

* Copy-paste the following commands in the terminal:

```
tm sm topo_countt1; tm cell_neighbor_number_graphs.R . output_analysis
```

```{r cell_neighbor_number_graphs, warning=FALSE, message=FALSE, fig.width=7, cache=FALSE, eval=TRUE, echo=FALSE,results='hide'}

mqf_cg_roi_cell_neighbor_count(movieDir, rois = c("raw")) %>%
  ggplot(aes(dev_time, avg_num_neighbors, color=movie)) +
  geom_line() + geom_smooth(color="blue") +
  xlab("Time [h]") +
  ylab("<Cell neighbor number>")  +
  facet_wrap(~roi) +
  ggtitle("averaged_cell_neighbor_number")

mqf_fg_cell_neighbor_count(movieDir, rois = c("raw"), polygon_class_limit=c(3,9)) %>%
  ggplot(aes(ac(polygon_class_trimmed), fill=as.factor(polygon_class_trimmed))) +
  geom_bar(color="white") +
  scale_fill_manual(values=c("3"="black", "4"="green", "5"="yellow", "6"="grey", "7"="blue", "8"="red","9"="purple"), name="polygon class") + 
  xlab("Cell neighbor number")  +
  facet_wrap(~roi) +
  ggtitle("cell_neighbor_number_distribution")

# mqf_fg_cell_neighbor_count(movieDir, rois = c("raw")) %>%
#   ggplot(aes(movie,polygon_class_trimmed, fill=movie)) +
#   geom_boxplot() +
#   ylab("Cell neighbor number")  +
#   ggtitle("cell_neighbor_number_boxplot")
# 
# mqf_fg_cell_neighbor_count(movieDir, rois = c("raw")) %>%
#   ggplot(aes(movie,polygon_class_trimmed, fill=movie)) +
#   geom_violin() +
#   ylab("Cell neighbor number")  +
#   ggtitle("cell_neighbor_number_violin")
```

[Where to find the results ?](../tm_qs_example_data.md#4-look-at-the-results) **|** 
[Back to tutorial list](../tm_qs_example_data.md#3-select-the-analysis-you-are-interested-in)

### 3. For further details

* compare multiple movies and ROI's, see [TM R User Manual](https://mpicbg-scicomp.github.io/tissue_miner/user_manual/TM_R-UserManual.html#comparing-averaged-quantities-between-movies-and-rois)
