---
output: 
  html_document: 
    keep_md: yes
---

# Cell packing analysis

Cell neighbor count is easily calculated from the database. It is therefore sufficient to build the database only.


### 1. Make a video of color-coded cell neighbor number plotted on the tissue

* Copy-paste the following commands in the terminal:

```
sm make_db 
cell_neighbor_number_pattern.R . output_analysis
```

```{r cell_area_pattern, warning=FALSE, message=FALSE, fig.width=11, cache=FALSE, eval=TRUE, echo=FALSE, results='hide'}
movieDir="/Users/retourna/MovieDB/WT_1"

scriptsDir=Sys.getenv("TM_HOME")
if(is.na(file.info(scriptsDir)$isdir)){
  stop(paste("TM_HOME not correctly defined (",scriptsDir ,")"))
}

source(file.path(scriptsDir, "commons/TMCommons.R"))
source(file.path(scriptsDir, "commons/BaseQueryFunctions.R"))
source(file.path(scriptsDir, "config/default_config.R"))

db <- openMovieDb(movieDir)

cellPolygonClass <- mqf_fg_cell_neighbor_count(movieDir, "raw", cellContour = T)

# Define a discrete color palette of polygon class
polygonClassColors <- c("2"="white","3"="black", "4"="green",
                        "5"="yellow", "6"="grey", "7"="blue",
                        "8"="red", "9"="purple", ">9"="black")

cellPolygonClass %>%
  render_frame(70) +
  geom_polygon(aes(x_pos, y_pos, fill=as.character(polygon_class_trimmed),
                   group=cell_id),  alpha=0.7) +
  scale_fill_manual(name="polygon class", values=polygonClassColors, drop=F) +
  ggtitle("PolygonClassPattern")


```

[Select another analysis](tm_qs_example_data.md)

### 2. Plot cell area distrubution and averages
* Copy-paste the following commands in the terminal:

```
sm make_db 
cell_neighbor_number_graphs.R . output_analysis
```

```{r cell_area_graphs, warning=FALSE, message=FALSE, fig.width=7, cache=FALSE, eval=TRUE, echo=FALSE,results='hide'}

mqf_cg_roi_cell_neighbor_count(movieDir, rois = c("raw")) %>%
  ggplot(aes(dev_time, avg_num_neighbors, color=movie)) +
  geom_line() + geom_smooth(color="blue") +
  xlab("Time [h]") +
  ylab("<Cell neighbor number>")  +
  facet_wrap(~roi) +
  ggtitle("averaged_cell_neighbor_number")

mqf_fg_cell_neighbor_count(movieDir, rois = c("raw"), polygon_class_limit=c(3,9)) %>%
  ggplot(aes(ac(polygon_class_trimmed), fill=as.factor(polygon_class_trimmed))) +
  geom_bar(color="white") +
  scale_fill_manual(values=c("3"="black", "4"="green", "5"="yellow", "6"="grey", "7"="blue", "8"="red","9"="purple"), name="polygon class") + 
  xlab("Cell neighbor number")  +
  facet_wrap(~roi) +
  ggtitle("cell_neighbor_number_distribution")

# mqf_fg_cell_neighbor_count(movieDir, rois = c("raw")) %>%
#   ggplot(aes(movie,polygon_class_trimmed, fill=movie)) +
#   geom_boxplot() +
#   ylab("Cell neighbor number")  +
#   ggtitle("cell_neighbor_number_boxplot")
# 
# mqf_fg_cell_neighbor_count(movieDir, rois = c("raw")) %>%
#   ggplot(aes(movie,polygon_class_trimmed, fill=movie)) +
#   geom_violin() +
#   ylab("Cell neighbor number")  +
#   ggtitle("cell_neighbor_number_violin")
```

[Select another analysis](tm_qs_example_data.md)

### 3. For further details
* filter by regions of interest, see [Master Guide](https://mpicbg-scicomp.github.io/tissue_miner/tm_tutorial/R-tutorial.html#plot-the-color-coded-cell-area-pattern-in-the-whole_tissue-roi)
* compare multiple movies and ROI's, see [Master Guide](https://mpicbg-scicomp.github.io/tissue_miner/tm_tutorial/R-tutorial.html#comparing-averaged-quantities-between-movies-and-rois)
